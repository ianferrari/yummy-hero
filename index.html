<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¥å¥çš„é¤æ¡Œå°éšŠé•· v4.0</title>
    <style>
        /* --- å…¨å±€è¨­å®š --- */
        body {
            font-family: "Mady Round", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #FFF8E1;
            margin: 0;
            height: 100vh;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
        }

        .hidden { display: none !important; }
        .screen {
            width: 100%; height: 100%;
            position: absolute; top: 0; left: 0;
            background-color: #FFF8E1;
            display: flex; flex-direction: column; align-items: center;
        }

        button { cursor: pointer; font-family: inherit; touch-action: manipulation; font-weight: bold;}

        /* --- 1. é¦–é é¸å–® --- */
        .menu-header {
            display: flex; justify-content: space-between; width: 90%; align-items: center;
            margin-top: 10px; margin-bottom: 10px;
        }
        .coin-display {
            background: #FFD54F; padding: 5px 15px; border-radius: 20px;
            font-size: 1.2rem; color: #5D4037; display: flex; align-items: center; gap: 5px;
            border: 2px solid #FFB300;
        }
        .farm-btn {
            background: #81C784; color: white; border: none; border-radius: 50px;
            padding: 8px 16px; font-size: 1.1rem; box-shadow: 0 4px 0 #388E3C;
        }

        .grid-container {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;
            padding: 10px; width: 90%; max-height: 75vh; overflow-y: auto;
        }
        .char-card {
            background: white; border: 3px solid #FFD54F; border-radius: 20px;
            padding: 10px; text-align: center; box-shadow: 0 4px 0 #FFB300;
        }
        .char-card:active { transform: scale(0.95); box-shadow: 0 0 0 #FFB300; }
        .char-icon { font-size: 3.5rem; display: block; margin-bottom: 5px;}
        .char-name { font-size: 1.2rem; color: #5D4037; }

        /* --- 2. éŠæˆ²å€ --- */
        .top-bar { position: absolute; top: 15px; left: 15px; z-index: 10; }
        .back-btn {
            background: #BCAAA4; color: white; border: none;
            padding: 10px 20px; border-radius: 30px; font-size: 1rem;
        }
        .main-character {
            font-size: 9rem; margin: 20px 0; transition: transform 0.2s;
            filter: drop-shadow(0 10px 10px rgba(0,0,0,0.1));
        }
        .eating { animation: eatAnim 0.4s ease-in-out; }
        @keyframes eatAnim {
            0% { transform: scale(1); } 50% { transform: scale(1.3) rotate(-10deg); } 100% { transform: scale(1); }
        }
        .message-box {
            height: 50px; color: #5D4037; font-weight: bold; font-size: 1.6rem;
            text-align: center; display: flex; align-items: center; justify-content: center;
        }
        .progress-container {
            width: 85%; height: 30px; background-color: #FFE082;
            border-radius: 20px; overflow: hidden; border: 4px solid #FFCA28; margin-bottom: 10px;
        }
        .progress-bar { height: 100%; width: 100%; background-color: #66BB6A; transition: width 0.5s; }
        .count-display { font-size: 1.5rem; color: #8D6E63; margin-bottom: 20px; }
        .feed-btn {
            background-color: #FF6F00; color: white; border: none; border-radius: 60px;
            padding: 20px 50px; font-size: 1.8rem; box-shadow: 0 8px 0 #E65100;
        }
        .feed-btn:active { box-shadow: 0 0 0 #E65100; transform: translateY(8px); }
        .feed-btn:disabled { background-color: #90A4AE; box-shadow: none; transform: none; }

        /* --- 3. è¾²å ´ (Habitat) --- */
        #farm-screen {
            background-color: #C8E6C9; /* è‰åœ°ç¶  */
            background-image: radial-gradient(#A5D6A7 15%, transparent 16%), radial-gradient(#A5D6A7 15%, transparent 16%);
            background-size: 60px 60px;
            background-position: 0 0, 30px 30px;
            overflow: hidden;
            position: relative;
        }
        .farm-toolbar {
            position: absolute; bottom: 0; width: 100%; background: rgba(255,255,255,0.9);
            padding: 10px; display: flex; justify-content: space-around; align-items: center;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 100;
        }
        .shop-btn {
            background: #FF7043; color: white; border: none; border-radius: 50px;
            padding: 10px 20px; font-size: 1.2rem; box-shadow: 0 4px 0 #D84315;
        }
        .farm-item {
            position: absolute; font-size: 4rem; cursor: grab;
            filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2));
            transition: transform 0.1s;
        }
        .farm-item:active { transform: scale(1.2); cursor: grabbing; z-index: 50; }

        /* --- 4. å•†åº— Modal --- */
        #shop-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 200;
            display: flex; justify-content: center; align-items: center;
        }
        .shop-content {
            background: white; width: 90%; height: 80%; border-radius: 20px;
            padding: 15px; overflow-y: auto; position: relative;
        }
        .shop-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 40px;
        }
        .shop-item {
            border: 2px solid #EEE; border-radius: 10px; padding: 10px; text-align: center;
        }
        .shop-item.too-expensive { opacity: 0.5; filter: grayscale(1); }
        .price-tag {
            background: #FFD54F; border-radius: 10px; padding: 2px 8px;
            font-size: 0.9rem; margin-top: 5px; display: inline-block;
        }
        .close-shop {
            position: absolute; top: 10px; right: 10px; background: #EF5350; color: white;
            border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 1.2rem;
        }

    </style>
</head>
<body>

    <div id="selection-screen" class="screen">
        <div class="menu-header">
            <div class="coin-display">ğŸ’° <span id="coin-balance">0</span></div>
            <button class="farm-btn" onclick="goToFarm()">ğŸ¡ å¥å¥çš„è¾²å ´</button>
        </div>
        <h2 style="color:#E65100; margin:0 0 10px 0;">ä»Šå¤©èª°è¦åƒé£¯ï¼Ÿ</h2>
        <div class="grid-container" id="grid"></div>
    </div>

    <div id="game-screen" class="screen hidden">
        <div class="top-bar"><button class="back-btn" onclick="goHome()">â¬… æ”¾æ£„</button></div>
        <div class="message-box" id="message"></div>
        <div class="main-character" id="char-display" onclick="pokeCharacter()"></div>
        <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>
        <div class="count-display">å‰© <span id="count">0</span> å£</div>
        <button class="feed-btn" id="feedBtn" onclick="feedAction()">é¤µä»–åƒ ğŸ¥„</button>
    </div>

    <div id="farm-screen" class="screen hidden">
        <div class="top-bar"><button class="back-btn" onclick="goHome()">â¬… å›å»</button></div>
        <div id="farm-area" style="width:100%; height:100%;"></div>
        
        <div class="farm-toolbar">
            <div class="coin-display">ğŸ’° <span id="farm-coin-balance">0</span></div>
            <button class="shop-btn" onclick="openShop()">ğŸ›’ è²·ç©å…·</button>
            <button class="back-btn" style="background:#EF5350; font-size:0.8rem;" onclick="clearFarm()">ğŸ—‘ï¸ æ¸…ç©º</button>
        </div>
    </div>

    <div id="shop-modal" class="hidden">
        <div class="shop-content">
            <button class="close-shop" onclick="closeShop()">âœ–</button>
            <h2 style="text-align:center; margin:0; color:#E65100;">ç©å…·åº—</h2>
            <div class="shop-grid" id="shop-grid"></div>
        </div>
    </div>

    <script>
        // --- æ ¸å¿ƒè³‡æ–™ ---
        // rate: èªé€Ÿ (0.7=æ…¢)
        const characters = [
            { id: 'police', name: 'è­¦å¯Ÿå”å”', icon: 'ğŸ‘®â€â™‚ï¸', msg: 'å¿«åƒé£¯ï¼Œè¦å·¡é‚äº†ï¼', pitch: 1, rate: 0.75 },
            { id: 'fire', name: 'æ¶ˆé˜²è»Š', icon: 'ğŸš’', msg: 'åŠ æ»¿æ°´ï¼Œæº–å‚™å‡ºç™¼ï¼', pitch: 0.8, rate: 0.75 },
            { id: 'train', name: 'é«˜éµ', icon: 'ğŸš…', msg: 'è»Šè»Šè¦é€²ç«™å›‰ï¼', pitch: 1, rate: 0.8 },
            { id: 'cleaner', name: 'åƒåœ¾è»Š', icon: 'ğŸš›', msg: 'å°ˆé–€åƒå‰©èœå‰©é£¯ï¼', pitch: 0.6, rate: 0.7 },
            { id: 'robot', name: 'æ©Ÿå™¨äºº', icon: 'ğŸ¤–', msg: 'èƒ½-é‡-ä¸-è¶³', pitch: 0.5, rate: 0.5 },
            { id: 'trex', name: 'æš´é¾', icon: 'ğŸ¦–', msg: 'å¼ï½æˆ‘è¦åƒäºŒåå£ï¼', pitch: 0.1, rate: 0.6 },
            { id: 'brachio', name: 'è…•é¾', icon: 'ğŸ¦•', msg: 'æ…¢æ…¢åƒï¼Œé•·é«˜é«˜ï½', pitch: 1.2, rate: 0.7 },
            { id: 'super', name: 'è¶…äºº', icon: 'ğŸ¦¸â€â™‚ï¸', msg: 'åƒé£½æ‰æœ‰åŠ›æ°£é£›ï¼', pitch: 1.1, rate: 0.8 }
        ];

        // å•†åº—ç‰©å“ (id, icon, price)
        const shopItems = [
            {id:'tree1', icon:'ğŸŒ²', price:50}, {id:'flower', icon:'ğŸŒ»', price:30}, {id:'house', icon:'ğŸ ', price:200},
            {id:'dog', icon:'ğŸ•', price:100}, {id:'car', icon:'ğŸï¸', price:150}, {id:'rocket', icon:'ğŸš€', price:300},
            {id:'egg', icon:'ğŸ¥š', price:50}, {id:'chick', icon:'ğŸ¥', price:80}, {id:'cake', icon:'ğŸ‚', price:120},
            {id:'slide', icon:'ğŸ¢', price:250}, {id:'tent', icon:'â›º', price:100}, {id:'gift', icon:'ğŸ', price:60}
        ];

        let totalBites = 20;
        let currentBites = 20;
        let selectedChar = null;
        
        // --- è³‡æ–™å­˜æª”ç³»çµ± (LocalStorage) ---
        let userData = {
            coins: 0,
            inventory: [] // æ ¼å¼: {id, x, y, icon}
        };

        function loadData() {
            const saved = localStorage.getItem('kui_v4_data');
            if(saved) userData = JSON.parse(saved);
            updateCoinDisplay();
        }

        function saveData() {
            localStorage.setItem('kui_v4_data', JSON.stringify(userData));
            updateCoinDisplay();
        }

        function updateCoinDisplay() {
            document.getElementById('coin-balance').innerText = userData.coins;
            document.getElementById('farm-coin-balance').innerText = userData.coins;
        }

        // --- èªéŸ³ç³»çµ± ---
        function speak(text, pitch = 1, rate = 0.75) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(text);
                u.pitch = pitch; u.rate = rate; u.lang = 'zh-TW';
                window.speechSynthesis.speak(u);
            }
        }
        
        // éŸ³æ•ˆ
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            
            if(type==='eat'){
                osc.type='sine'; osc.frequency.setValueAtTime(300,audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(600,audioCtx.currentTime+0.1);
                gain.gain.setValueAtTime(0.5,audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.1);
                osc.start(); osc.stop(audioCtx.currentTime+0.1);
            } else if(type==='coin'){
                // é‡‘å¹£è²
                osc.type='square'; 
                osc.frequency.setValueAtTime(1000,audioCtx.currentTime);
                osc.frequency.setValueAtTime(1500,audioCtx.currentTime+0.1);
                gain.gain.setValueAtTime(0.1,audioCtx.currentTime);
                gain.gain.linearRampToValueAtTime(0,audioCtx.currentTime+0.2);
                osc.start(); osc.stop(audioCtx.currentTime+0.2);
            } else if(type==='win'){
                playNote(523,0,0.2); playNote(659,0.2,0.2); playNote(784,0.4,0.4);
            }
        }
        function playNote(f,t,d){
            const o=audioCtx.createOscillator();const g=audioCtx.createGain();
            o.connect(g);g.connect(audioCtx.destination);o.frequency.value=f;
            g.gain.setValueAtTime(0.2,audioCtx.currentTime+t);
            g.gain.linearRampToValueAtTime(0,audioCtx.currentTime+t+d);
            o.start(audioCtx.currentTime+t);o.stop(audioCtx.currentTime+t+d);
        }

        // --- ä»‹é¢åˆ‡æ› ---
        const screens = {
            select: document.getElementById('selection-screen'),
            game: document.getElementById('game-screen'),
            farm: document.getElementById('farm-screen')
        };
        function switchScreen(name) {
            Object.values(screens).forEach(s => s.classList.add('hidden'));
            screens[name].classList.remove('hidden');
        }

        // --- éŠæˆ²é‚è¼¯ ---
        function initMenu() {
            loadData();
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            characters.forEach(char => {
                let card = document.createElement('div');
                card.className = 'char-card';
                card.innerHTML = `<span class="char-icon">${char.icon}</span><span class="char-name">${char.name}</span>`;
                card.onclick = () => { speak(char.name, 1, 0.8); setTimeout(() => startGame(char), 500); };
                grid.appendChild(card);
            });
        }

        function startGame(char) {
            selectedChar = char;
            currentBites = totalBites;
            switchScreen('game');
            document.getElementById('char-display').innerText = char.icon;
            document.getElementById('message').innerText = char.msg;
            document.getElementById('count').innerText = currentBites;
            document.getElementById('progressBar').style.width = '100%';
            document.getElementById('progressBar').style.backgroundColor = '#66BB6A';
            const btn = document.getElementById('feedBtn');
            btn.disabled = false; btn.innerText = "é¤µä»–åƒ ğŸ¥„"; btn.style.backgroundColor = '#FF6F00';
            setTimeout(() => speak(`æˆ‘æ˜¯${char.name}ï¼Œ${char.msg}`, char.pitch, char.rate), 600);
        }

        function feedAction() {
            if (currentBites <= 0) return;
            currentBites--;
            document.getElementById('count').innerText = currentBites;
            let pct = (currentBites / totalBites) * 100;
            const pBar = document.getElementById('progressBar');
            pBar.style.width = pct + "%";
            if (pct < 30) pBar.style.backgroundColor = "#EF5350";
            
            const charDiv = document.getElementById('char-display');
            charDiv.classList.add('eating'); playSound('eat');
            
            const words = ["é˜¿å§†", "å¥½åƒ", "å†ä¾†", "çœŸæ£’"];
            speak(words[Math.floor(Math.random()*words.length)], selectedChar.pitch, 1.0);
            
            setTimeout(() => {
                charDiv.classList.remove('eating');
                if (currentBites <= 0) finishGame();
            }, 300);
        }

        function finishGame() {
            const btn = document.getElementById('feedBtn');
            btn.innerText = "ä»»å‹™é”æˆï¼é ˜çé‡‘ï¼ğŸ’°";
            btn.disabled = true; btn.style.backgroundColor = "#66BB6A";
            document.getElementById('message').innerText = "åƒé£½äº†ï¼ç²å¾—100å…ƒï¼";
            playSound('win');
            speak(`åƒé£½äº†ï¼å¥å¥å¥½æ£’ï¼å¾—åˆ°ä¸€ç™¾å…ƒï¼`, selectedChar.pitch, 0.8);
            
            // çå‹µçµç®—
            userData.coins += 100;
            saveData();
            
            // å½©å¸¶
            let i = 0; let interval = setInterval(() => { if(i > 15) clearInterval(interval); createConfetti(); i++; }, 200);
        }

        function goHome() {
            switchScreen('select');
            document.body.style.backgroundColor = '#FFF8E1';
            speak("æƒ³åšä»€éº¼å‘¢ï¼Ÿ", 1, 0.8);
        }

        function createConfetti() {
            const c = document.createElement('div');
            c.innerText = ['ğŸ’°','âœ¨','â­'][Math.floor(Math.random()*3)];
            c.style.position='absolute'; c.style.left=Math.random()*90+5+'vw'; c.style.top='-10vh';
            c.style.fontSize='2rem'; c.style.transition='top 2.5s ease-in';
            document.body.appendChild(c);
            setTimeout(()=>c.style.top='110vh',50); setTimeout(()=>c.remove(),2600);
        }

        function pokeCharacter() {
            const charDiv = document.getElementById('char-display');
            charDiv.classList.add('eating');
            setTimeout(()=>charDiv.classList.remove('eating'), 300);
            speak("è‚šå­é¤“é¤“", selectedChar.pitch, selectedChar.rate);
        }

        // --- è¾²å ´èˆ‡å•†åº—é‚è¼¯ ---
        function goToFarm() {
            switchScreen('farm');
            renderFarm();
            speak("æ­¡è¿ä¾†åˆ°å¥å¥çš„è¾²å ´", 1, 0.8);
        }

        function renderFarm() {
            const area = document.getElementById('farm-area');
            area.innerHTML = '';
            userData.inventory.forEach((item, index) => {
                const el = document.createElement('div');
                el.className = 'farm-item';
                el.innerText = item.icon;
                el.style.left = item.x + 'px';
                el.style.top = item.y + 'px';
                
                // æ‹–æ›³é‚è¼¯
                el.addEventListener('touchstart', (e) => dragStart(e, el, index), {passive: false});
                
                area.appendChild(el);
            });
        }

        // ç°¡å–®æ‹–æ›³å¯¦ä½œ
        let activeItem = null;
        let activeIndex = -1;
        let offset = {x:0, y:0};

        function dragStart(e, el, index) {
            e.preventDefault();
            activeItem = el;
            activeIndex = index;
            const touch = e.touches[0];
            offset.x = touch.clientX - el.offsetLeft;
            offset.y = touch.clientY - el.offsetTop;
            
            document.addEventListener('touchmove', dragMove, {passive: false});
            document.addEventListener('touchend', dragEnd);
        }

        function dragMove(e) {
            if (!activeItem) return;
            e.preventDefault();
            const touch = e.touches[0];
            activeItem.style.left = (touch.clientX - offset.x) + 'px';
            activeItem.style.top = (touch.clientY - offset.y) + 'px';
        }

        function dragEnd() {
            if (activeItem && activeIndex !== -1) {
                // æ›´æ–°åº§æ¨™ä¸¦å­˜æª”
                userData.inventory[activeIndex].x = parseInt(activeItem.style.left);
                userData.inventory[activeIndex].y = parseInt(activeItem.style.top);
                saveData();
            }
            activeItem = null;
            document.removeEventListener('touchmove', dragMove);
            document.removeEventListener('touchend', dragEnd);
        }

        function openShop() {
            document.getElementById('shop-modal').classList.remove('hidden');
            const grid = document.getElementById('shop-grid');
            grid.innerHTML = '';
            shopItems.forEach(item => {
                const div = document.createElement('div');
                div.className = 'shop-item';
                if(userData.coins < item.price) div.classList.add('too-expensive');
                div.innerHTML = `
                    <div style="font-size:2.5rem">${item.icon}</div>
                    <div class="price-tag">ğŸ’°${item.price}</div>
                `;
                div.onclick = () => buyItem(item);
                grid.appendChild(div);
            });
        }

        function closeShop() { document.getElementById('shop-modal').classList.add('hidden'); }

        function buyItem(item) {
            if (userData.coins >= item.price) {
                if(confirm(`è¦è²·ä¸€å€‹ ${item.icon} å—ï¼Ÿ`)) {
                    userData.coins -= item.price;
                    // æ–°è²·çš„ç‰©å“é è¨­æ”¾åœ¨ä¸­é–“éš¨æ©Ÿä½ç½®
                    userData.inventory.push({
                        id: item.id,
                        icon: item.icon,
                        x: 100 + Math.random()*100,
                        y: 200 + Math.random()*100
                    });
                    saveData();
                    playSound('coin');
                    speak("è²·åˆ°äº†ï¼å¥½æ£’ï¼", 1, 0.9);
                    closeShop();
                    renderFarm();
                }
            } else {
                speak("éŒ¢éŒ¢ä¸å¤ å–”ï¼Œå¿«å»åƒé£¯è³ºéŒ¢ï¼", 1, 0.9);
            }
        }

        function clearFarm() {
            if(confirm("ç¢ºå®šè¦å…¨éƒ¨æ¸…ç©ºé‡ä¾†å—ï¼Ÿ(éŒ¢æœƒä¿ç•™)")) {
                userData.inventory = [];
                saveData();
                renderFarm();
            }
        }

        // å•Ÿå‹•
        initMenu();

    </script>
</body>
</html>
