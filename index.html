<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¥å¥çš„é¤æ¡Œå°éšŠé•· v3</title>
    <style>
        /* --- å…¨å±€è¨­å®š --- */
        body {
            font-family: "Mady Round", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #FFF8E1;
            margin: 0;
            height: 100vh;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none; /* é˜²æ­¢ iPad ä¸‹æ‹‰åˆ·æ–° */
        }

        /* --- é€šç”¨é¡åˆ¥ --- */
        .hidden { display: none !important; }
        .screen {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: 0;
            left: 0;
            background-color: #FFF8E1;
            transition: opacity 0.3s;
        }

        /* æŒ‰éˆ•åŸºç¤æ¨£å¼ */
        button {
            cursor: pointer;
            font-family: inherit;
            touch-action: manipulation;
        }

        /* --- 1. é¦–é èˆ‡é¸å–® --- */
        .menu-header {
            display: flex;
            justify-content: space-between;
            width: 90%;
            align-items: center;
            margin-bottom: 10px;
        }

        .menu-title {
            color: #E65100;
            font-size: 1.5rem;
            margin: 0;
        }

        .draw-mode-btn {
            background: #29B6F6;
            color: white;
            border: none;
            border-radius: 50px;
            padding: 10px 20px;
            font-size: 1.2rem;
            box-shadow: 0 4px 0 #0288D1;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            padding: 10px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .char-card {
            background: white;
            border: 3px solid #FFD54F;
            border-radius: 20px;
            padding: 10px;
            text-align: center;
            box-shadow: 0 4px 0 #FFB300;
            transition: transform 0.1s;
        }
        .char-card:active { transform: scale(0.95); box-shadow: 0 0 0 #FFB300; }
        .char-icon { font-size: 3.5rem; display: block; margin-bottom: 5px;}
        .char-name { font-size: 1.1rem; color: #5D4037; font-weight: bold; }

        /* --- 2. éŠæˆ²é é¢ --- */
        .top-bar {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 10;
        }
        .back-btn {
            background: #BCAAA4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 30px;
            font-size: 1rem;
            font-weight: bold;
        }

        .main-character {
            font-size: 9rem;
            transition: transform 0.2s;
            margin: 20px 0;
            filter: drop-shadow(0 10px 10px rgba(0,0,0,0.1));
        }
        
        /* åƒæ±è¥¿å‹•ç•«ï¼šæ”¾å¤§ + æ–æ“º */
        @keyframes eatAnim {
            0% { transform: scale(1); }
            50% { transform: scale(1.3) rotate(-10deg); }
            100% { transform: scale(1); }
        }
        .eating { animation: eatAnim 0.3s ease-in-out; }

        .message-box {
            height: 40px;
            color: #5D4037;
            font-weight: bold;
            font-size: 1.5rem;
            text-align: center;
        }

        .progress-container {
            width: 85%;
            height: 30px;
            background-color: #FFE082;
            border-radius: 20px;
            overflow: hidden;
            border: 4px solid #FFCA28;
            margin-bottom: 10px;
        }
        .progress-bar { height: 100%; width: 100%; background-color: #66BB6A; transition: width 0.5s; }
        .count-display { font-size: 1.5rem; color: #8D6E63; font-weight: bold; margin-bottom: 20px; }

        .feed-btn {
            background-color: #FF6F00;
            color: white;
            border: none;
            border-radius: 60px;
            padding: 20px 60px;
            font-size: 1.8rem;
            font-weight: bold;
            box-shadow: 0 8px 0 #E65100;
            transition: transform 0.1s;
        }
        .feed-btn:active { box-shadow: 0 0 0 #E65100; transform: translateY(8px); }
        .feed-btn:disabled { background-color: #90A4AE; box-shadow: none; transform: none; }

        /* --- 3. å¡—é´‰é é¢ --- */
        #drawing-screen { background-color: #fff; }
        
        .toolbar {
            position: absolute;
            bottom: 0;
            width: 100%;
            background: #EEE;
            padding: 15px 10px;
            display: flex;
            justify-content: center;
            gap: 10px;
            box-sizing: border-box;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }

        .color-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: transform 0.2s;
        }
        .color-btn.active { transform: scale(1.2); border-color: #333; }

        .tool-btn {
            width: 45px;
            height: 45px;
            border-radius: 10px;
            border: none;
            background: white;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .tool-btn:active { background: #ddd; }

        canvas {
            touch-action: none; /* é—œéµï¼šè®“ canvas å¯ä»¥ç•«åœ–è€Œä¸æ˜¯æ²å‹•é é¢ */
        }

    </style>
</head>
<body>

    <div id="selection-screen" class="screen">
        <div class="menu-header">
            <h2 class="menu-title">èª°è¦åƒé£¯ï¼Ÿ</h2>
            <button class="draw-mode-btn" onclick="goToDrawing()">
                ğŸ¨ ç•«ç•«
            </button>
        </div>
        <div class="grid-container" id="grid"></div>
    </div>

    <div id="game-screen" class="screen hidden">
        <div class="top-bar">
            <button class="back-btn" onclick="goHome()">â¬… å›å»</button>
        </div>

        <div class="message-box" id="message"></div>
        <div class="main-character" id="char-display" onclick="pokeCharacter()"></div>

        <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        <div class="count-display">å‰© <span id="count">0</span> å£</div>

        <button class="feed-btn" id="feedBtn" onclick="feedAction()">é¤µä»–åƒ ğŸ¥„</button>
    </div>

    <div id="drawing-screen" class="screen hidden">
        <div class="top-bar">
            <button class="back-btn" onclick="goHome()">â¬… ä¸ç•«äº†</button>
        </div>
        <canvas id="drawCanvas"></canvas>
        
        <div class="toolbar">
            <button class="color-btn" style="background:#F44336" onclick="setColor('#F44336', this)"></button>
            <button class="color-btn" style="background:#FF9800" onclick="setColor('#FF9800', this)"></button>
            <button class="color-btn" style="background:#FFEB3B" onclick="setColor('#FFEB3B', this)"></button>
            <button class="color-btn active" style="background:#4CAF50" onclick="setColor('#4CAF50', this)"></button>
            <button class="color-btn" style="background:#2196F3" onclick="setColor('#2196F3', this)"></button>
            <button class="color-btn" style="background:#9C27B0" onclick="setColor('#9C27B0', this)"></button>
            <button class="color-btn" style="background:#333333" onclick="setColor('#333333', this)"></button>
            
            <div style="width: 10px;"></div> <button class="tool-btn" onclick="setEraser()" title="æ©¡çš®æ“¦">ğŸ§¼</button>
            <button class="tool-btn" onclick="clearCanvas()" title="å…¨éƒ¨æ¸…é™¤" style="color:red">ğŸ—‘ï¸</button>
        </div>
    </div>

    <script>
        // --- è¨­å®šå€ ---
        // pitch: 0.1(ä½æ²‰) ~ 2(é«˜å°–), rate: é€Ÿåº¦
        const characters = [
            { id: 'police', name: 'è­¦å¯Ÿå”å”', icon: 'ğŸ‘®â€â™‚ï¸', msg: 'ç¶­æŒç§©åºï¼Œåƒé£¯ï¼', pitch: 1, type: 'human' },
            { id: 'fire', name: 'æ¶ˆé˜²è»Š', icon: 'ğŸš’', msg: 'æ»…ç«éœ€è¦é«”åŠ›ï¼', pitch: 0.8, type: 'machine' },
            { id: 'train', name: 'é«˜éµ', icon: 'ğŸš…', msg: 'è»Šè»Šè¦é€²ç«™å›‰ï¼', pitch: 1, type: 'machine' },
            { id: 'worker', name: 'å·¥äººå”å”', icon: 'ğŸ‘·â€â™‚ï¸', msg: 'è“‹æˆ¿å­è¦åŠ›æ°£ï¼', pitch: 0.9, type: 'human' },
            { id: 'cleaner', name: 'åƒåœ¾è»Š', icon: 'ğŸš›', msg: 'å°ˆé–€åƒå‰©èœå‰©é£¯ï¼', pitch: 0.6, type: 'machine' },
            { id: 'robot', name: 'æ©Ÿå™¨äºº', icon: 'ğŸ¤–', msg: 'è£œ-å……-èƒ½-é‡-å—¶-æ³¢', pitch: 0.5, rate: 0.8, type: 'robot' },
            { id: 'lion', name: 'ç…å­', icon: 'ğŸ¦', msg: 'å¼ï½æˆ‘è¦åƒè‚‰è‚‰ï¼', pitch: 0.7, type: 'animal' },
            { id: 'trex', name: 'æš´é¾', icon: 'ğŸ¦–', msg: 'æˆ‘æ˜¯æé¾ä¹‹ç‹ï¼', pitch: 0.1, rate: 0.8, type: 'animal' },
            { id: 'brachio', name: 'è…•é¾', icon: 'ğŸ¦•', msg: 'æˆ‘è„–å­é•·é•·è¦åƒèœ', pitch: 1.2, type: 'animal' },
            { id: 'rocket', name: 'ç«ç®­', icon: 'ğŸš€', msg: 'æº–å‚™ç™¼å°„ï¼å€’æ•¸ï¼', pitch: 1, type: 'machine' },
            { id: 'super', name: 'è¶…äºº', icon: 'ğŸ¦¸â€â™‚ï¸', msg: 'åƒé£½æ‰èƒ½æ•‘åœ°çƒï¼', pitch: 1.2, type: 'human' }
        ];

        let totalBites = 20;
        let currentBites = 20;
        let selectedChar = null;
        
        // --- éŸ³æ•ˆç³»çµ± (AudioContext) ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();

        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            if (type === 'eat') {
                // å¯æ„›çš„å•µå•µè²
                osc.type = 'sine';
                osc.frequency.setValueAtTime(400, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(800, audioCtx.currentTime + 0.1);
                gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.1);
            } else if (type === 'win') {
                // å‹åˆ©éŸ³æ•ˆ (ç°¡å–®çš„å’Œå¼¦)
                playNote(523.25, 0, 0.2); // C
                playNote(659.25, 0.2, 0.2); // E
                playNote(783.99, 0.4, 0.4); // G
            }
        }

        function playNote(freq, startTime, duration) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.type = 'triangle';
            osc.frequency.value = freq;
            gain.gain.setValueAtTime(0.3, audioCtx.currentTime + startTime);
            gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + startTime + duration);
            osc.start(audioCtx.currentTime + startTime);
            osc.stop(audioCtx.currentTime + startTime + duration);
        }

        // --- èªéŸ³ç³»çµ± (TTS) ---
        function speak(text, pitch = 1, rate = 1) {
            // å¦‚æœç€è¦½å™¨æ”¯æ´èªªè©±
            if ('speechSynthesis' in window) {
                // åœæ­¢æ­£åœ¨èªªçš„è©±
                window.speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.pitch = pitch; // èªèª¿é«˜ä½
                utterance.rate = rate;   // èªªè©±é€Ÿåº¦
                utterance.lang = 'zh-TW'; // è¨­å®šä¸­æ–‡
                window.speechSynthesis.speak(utterance);
            }
        }

        // --- é é¢æ§åˆ¶ ---
        const screens = {
            select: document.getElementById('selection-screen'),
            game: document.getElementById('game-screen'),
            draw: document.getElementById('drawing-screen')
        };

        function switchScreen(screenName) {
            Object.values(screens).forEach(s => s.classList.add('hidden'));
            screens[screenName].classList.remove('hidden');
        }

        function goHome() {
            switchScreen('select');
            document.body.style.backgroundColor = '#FFF8E1';
        }

        function initMenu() {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            characters.forEach(char => {
                let card = document.createElement('div');
                card.className = 'char-card';
                card.innerHTML = `<span class="char-icon">${char.icon}</span><span class="char-name">${char.name}</span>`;
                card.onclick = () => startGame(char);
                grid.appendChild(card);
            });
        }

        // --- éŠæˆ²é‚è¼¯ ---
        function startGame(char) {
            selectedChar = char;
            currentBites = totalBites;
            switchScreen('game');

            // UI åˆå§‹åŒ–
            document.getElementById('char-display').innerText = char.icon;
            document.getElementById('message').innerText = char.msg;
            document.getElementById('count').innerText = currentBites;
            
            const pBar = document.getElementById('progressBar');
            pBar.style.width = '100%';
            pBar.style.backgroundColor = '#66BB6A';
            
            const btn = document.getElementById('feedBtn');
            btn.disabled = false;
            btn.innerText = "é¤µä»–åƒ ğŸ¥„";
            btn.style.backgroundColor = '#FF6F00';

            // è§’è‰²é–‹å ´ç™½
            setTimeout(() => {
                speak(`${char.name}ä¾†å›‰ï¼${char.msg}`, char.pitch, char.rate || 1);
            }, 500);
        }

        function pokeCharacter() {
            // é»æ“Šè§’è‰²æœƒæœ‰åæ‡‰
            const char = document.getElementById('char-display');
            char.classList.add('eating');
            playSound('eat');
            setTimeout(() => char.classList.remove('eating'), 300);
            
            // éš¨æ©Ÿèªªè©±
            const mood = ["å¥½é¤“å–”", "å¿«é¤µæˆ‘", "é‚„æœ‰å¤šä¹…", "é˜¿å§†é˜¿å§†"];
            speak(mood[Math.floor(Math.random()*mood.length)], selectedChar.pitch);
        }

        function feedAction() {
            if (currentBites <= 0) return;

            currentBites--;
            document.getElementById('count').innerText = currentBites;
            
            // é€²åº¦æ¢
            let pct = (currentBites / totalBites) * 100;
            const pBar = document.getElementById('progressBar');
            pBar.style.width = pct + "%";
            if (pct < 30) pBar.style.backgroundColor = "#EF5350";

            // å‹•ç•« & éŸ³æ•ˆ
            const charDiv = document.getElementById('char-display');
            charDiv.classList.add('eating');
            playSound('eat');
            
            document.getElementById('message').innerText = "é˜¿å§†ï¼å¥½åƒï¼";

            setTimeout(() => {
                charDiv.classList.remove('eating');
                if (currentBites > 0) {
                    document.getElementById('message').innerText = "é‚„è¦é‚„è¦...";
                } else {
                    finishGame();
                }
            }, 300);
        }

        function finishGame() {
            document.getElementById('message').innerText = "åƒé£½äº†ï¼å¥å¥å¤ªæ£’äº†ï¼";
            const btn = document.getElementById('feedBtn');
            btn.innerText = "ä»»å‹™é”æˆ ğŸ‰";
            btn.disabled = true;
            btn.style.backgroundColor = "#66BB6A";
            document.body.style.backgroundColor = "#E8F5E9";
            
            playSound('win');
            speak(`å“‡ï¼${selectedChar.name}åƒé£½äº†ï¼è¬è¬å¥å¥ï¼`, selectedChar.pitch);
            
            // å½©å¸¶
            let i = 0;
            let interval = setInterval(() => {
                if(i > 15) clearInterval(interval);
                createConfetti();
                i++;
            }, 200);
        }

        function createConfetti() {
            const c = document.createElement('div');
            c.innerText = ['ğŸ‰', 'â­', 'ğŸˆ', 'âœ¨'][Math.floor(Math.random()*4)];
            c.style.position = 'absolute';
            c.style.left = Math.random()*90 + 5 + 'vw';
            c.style.top = '-10vh';
            c.style.fontSize = '2rem';
            c.style.transition = 'top 2.5s ease-in';
            c.style.zIndex = 100;
            document.body.appendChild(c);
            setTimeout(() => c.style.top = '110vh', 50);
            setTimeout(() => c.remove(), 2600);
        }

        // --- å¡—é´‰åŠŸèƒ½é‚è¼¯ (Canvas) ---
        let canvas, ctx, isDrawing = false;
        let lastX = 0, lastY = 0;
        let brushColor = '#4CAF50';
        let brushSize = 5;

        function goToDrawing() {
            switchScreen('draw');
            initCanvas();
        }

        function initCanvas() {
            canvas = document.getElementById('drawCanvas');
            ctx = canvas.getContext('2d');
            resizeCanvas();
            
            // äº‹ä»¶ç›£è½ (æ”¯æ´æ»‘é¼ èˆ‡è§¸æ§)
            canvas.addEventListener('mousedown', startDraw);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', () => isDrawing = false);
            canvas.addEventListener('mouseout', () => isDrawing = false);

            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault(); // é˜²æ­¢æ²å‹•
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent("mousedown", {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            }, {passive: false});

            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent("mousemove", {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            }, {passive: false});

            canvas.addEventListener('touchend', () => isDrawing = false);
        }

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            // è¦–çª—æ”¹è®Šå¤§å°æ™‚ï¼Œå¯èƒ½æœƒæ¸…é™¤ç•«é¢ï¼Œé€™è£¡ç°¡å–®è™•ç†å°±ä¸ä¿å­˜èˆŠåœ–äº†
        }

        function startDraw(e) {
            isDrawing = true;
            [lastX, lastY] = [e.clientX, e.clientY];
        }

        function draw(e) {
            if (!isDrawing) return;
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(e.clientX, e.clientY);
            ctx.strokeStyle = brushColor;
            ctx.lineWidth = brushSize;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.stroke();
            [lastX, lastY] = [e.clientX, e.clientY];
        }

        function setColor(color, btn) {
            brushColor = color;
            brushSize = 5; // æ¢å¾©ç­†åˆ·å¤§å°
            document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        function setEraser() {
            brushColor = '#FFFFFF';
            brushSize = 30; // æ©¡çš®æ“¦å¤§ä¸€é»
            document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
        }

        function clearCanvas() {
            if(confirm('è¦é‡æ–°ç•«ä¸€å¼µå—ï¼Ÿ')) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
        }

        window.addEventListener('resize', resizeCanvas);
        
        // å•Ÿå‹•
        initMenu();

    </script>
</body>
</html>
