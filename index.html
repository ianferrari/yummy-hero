<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¥å¥çš„é¤æ¡Œå°éšŠé•· v3.1</title>
    <style>
        /* --- å…¨å±€è¨­å®š --- */
        body {
            font-family: "Mady Round", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #FFF8E1;
            margin: 0;
            height: 100vh;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
        }

        .hidden { display: none !important; }
        .screen {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: 0;
            left: 0;
            background-color: #FFF8E1;
        }

        button { cursor: pointer; font-family: inherit; touch-action: manipulation; }

        /* --- 1. é¸å–® --- */
        .menu-header {
            display: flex;
            justify-content: space-between;
            width: 90%;
            align-items: center;
            margin-bottom: 10px;
        }
        .menu-title { color: #E65100; font-size: 1.5rem; margin: 0; }
        .draw-mode-btn {
            background: #29B6F6; color: white; border: none; border-radius: 50px;
            padding: 8px 16px; font-size: 1.1rem; box-shadow: 0 4px 0 #0288D1;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            padding: 10px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .char-card {
            background: white; border: 3px solid #FFD54F; border-radius: 20px;
            padding: 10px; text-align: center; box-shadow: 0 4px 0 #FFB300;
        }
        .char-card:active { transform: scale(0.95); box-shadow: 0 0 0 #FFB300; }
        .char-icon { font-size: 3.5rem; display: block; margin-bottom: 5px;}
        .char-name { font-size: 1.2rem; color: #5D4037; font-weight: bold; }

        /* --- 2. éŠæˆ²å€ --- */
        .top-bar { position: absolute; top: 15px; left: 15px; z-index: 10; }
        .back-btn {
            background: #BCAAA4; color: white; border: none;
            padding: 10px 20px; border-radius: 30px; font-size: 1rem; font-weight: bold;
        }

        .main-character {
            font-size: 9rem; margin: 20px 0; transition: transform 0.2s;
            filter: drop-shadow(0 10px 10px rgba(0,0,0,0.1));
        }
        .eating { animation: eatAnim 0.4s ease-in-out; }
        @keyframes eatAnim {
            0% { transform: scale(1); }
            50% { transform: scale(1.3) rotate(-10deg); }
            100% { transform: scale(1); }
        }

        .message-box {
            height: 50px; color: #5D4037; font-weight: bold; font-size: 1.6rem;
            text-align: center; display: flex; align-items: center; justify-content: center;
        }

        .progress-container {
            width: 85%; height: 30px; background-color: #FFE082;
            border-radius: 20px; overflow: hidden; border: 4px solid #FFCA28; margin-bottom: 10px;
        }
        .progress-bar { height: 100%; width: 100%; background-color: #66BB6A; transition: width 0.5s; }
        .count-display { font-size: 1.5rem; color: #8D6E63; font-weight: bold; margin-bottom: 20px; }

        .feed-btn {
            background-color: #FF6F00; color: white; border: none; border-radius: 60px;
            padding: 20px 50px; font-size: 1.8rem; font-weight: bold;
            box-shadow: 0 8px 0 #E65100; transition: transform 0.1s;
        }
        .feed-btn:active { box-shadow: 0 0 0 #E65100; transform: translateY(8px); }
        .feed-btn:disabled { background-color: #90A4AE; box-shadow: none; transform: none; }

        /* --- 3. ç•«å¸ƒ --- */
        #drawing-screen { background-color: #fff; }
        .toolbar {
            position: absolute; bottom: 0; width: 100%; background: #EEE;
            padding: 15px 10px; display: flex; justify-content: center; gap: 10px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1); box-sizing: border-box;
        }
        .color-btn { width: 45px; height: 45px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .color-btn.active { transform: scale(1.2); border-color: #333; }
        .tool-btn { width: 45px; height: 45px; border-radius: 10px; border: none; background: white; font-size: 1.5rem; }
        canvas { touch-action: none; }
    </style>
</head>
<body>

    <div id="selection-screen" class="screen">
        <div class="menu-header">
            <h2 class="menu-title">èª°è¦åƒé£¯ï¼Ÿ</h2>
            <button class="draw-mode-btn" onclick="goToDrawing()">ğŸ¨ ç•«ç•«</button>
        </div>
        <div class="grid-container" id="grid"></div>
    </div>

    <div id="game-screen" class="screen hidden">
        <div class="top-bar"><button class="back-btn" onclick="goHome()">â¬… å›å»</button></div>
        
        <div class="message-box" id="message"></div>
        <div class="main-character" id="char-display" onclick="pokeCharacter()"></div>

        <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>
        <div class="count-display">å‰© <span id="count">0</span> å£</div>

        <button class="feed-btn" id="feedBtn" onclick="feedAction()">é¤µä»–åƒ ğŸ¥„</button>
    </div>

    <div id="drawing-screen" class="screen hidden">
        <div class="top-bar"><button class="back-btn" onclick="goHome()">â¬… ä¸ç•«äº†</button></div>
        <canvas id="drawCanvas"></canvas>
        <div class="toolbar">
            <button class="color-btn" style="background:#F44336" onclick="setColor('#F44336', this)"></button>
            <button class="color-btn" style="background:#FF9800" onclick="setColor('#FF9800', this)"></button>
            <button class="color-btn active" style="background:#4CAF50" onclick="setColor('#4CAF50', this)"></button>
            <button class="color-btn" style="background:#2196F3" onclick="setColor('#2196F3', this)"></button>
            <button class="tool-btn" onclick="setEraser()">ğŸ§¼</button>
            <button class="tool-btn" onclick="clearCanvas()" style="color:red">ğŸ—‘ï¸</button>
        </div>
    </div>

    <script>
        // --- è§’è‰²è³‡æ–™ (rate: èªé€Ÿ, 1æ˜¯æ­£å¸¸, 0.7æ˜¯æ…¢é€Ÿ) ---
        const characters = [
            { id: 'police', name: 'è­¦å¯Ÿå”å”', icon: 'ğŸ‘®â€â™‚ï¸', msg: 'å¿«åƒé£¯ï¼Œè¦å·¡é‚äº†ï¼', pitch: 1, rate: 0.75 },
            { id: 'fire', name: 'æ¶ˆé˜²è»Š', icon: 'ğŸš’', msg: 'åŠ æ»¿æ°´ï¼Œæº–å‚™å‡ºç™¼ï¼', pitch: 0.8, rate: 0.75 },
            { id: 'train', name: 'é«˜éµ', icon: 'ğŸš…', msg: 'å„ä½æ—…å®¢ï¼Œè«‹åƒé£¯ï¼', pitch: 1, rate: 0.8 },
            { id: 'cleaner', name: 'åƒåœ¾è»Š', icon: 'ğŸš›', msg: 'æˆ‘ä¸æŒ‘é£Ÿï¼Œä»€éº¼éƒ½åƒï¼', pitch: 0.6, rate: 0.7 },
            { id: 'robot', name: 'æ©Ÿå™¨äºº', icon: 'ğŸ¤–', msg: 'èƒ½-é‡-ä¸-è¶³-è«‹-é¤µ-é£Ÿ', pitch: 0.5, rate: 0.5 }, // æ©Ÿå™¨äººç‰¹æ…¢
            { id: 'trex', name: 'æš´é¾', icon: 'ğŸ¦–', msg: 'å¼ï½æˆ‘è¦åƒäºŒåå£ï¼', pitch: 0.1, rate: 0.6 }, // æš´é¾æ…¢ä¸”ä½æ²‰
            { id: 'brachio', name: 'è…•é¾', icon: 'ğŸ¦•', msg: 'æ…¢æ…¢åƒï¼Œé•·é«˜é«˜ï½', pitch: 1.2, rate: 0.7 },
            { id: 'super', name: 'è¶…äºº', icon: 'ğŸ¦¸â€â™‚ï¸', msg: 'åƒé£½æ‰æœ‰åŠ›æ°£é£›ï¼', pitch: 1.1, rate: 0.8 }
        ];

        let totalBites = 20;
        let currentBites = 20;
        let selectedChar = null;
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();

        // --- æ ¸å¿ƒèªéŸ³åŠŸèƒ½ (å„ªåŒ–ç‰ˆ) ---
        function speak(text, pitch = 1, rate = 0.75) { // é è¨­èªé€Ÿ 0.75 (æ…¢é€Ÿ)
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel(); // æ‰“æ–·ä¸Šä¸€å¥
                const u = new SpeechSynthesisUtterance(text);
                u.pitch = pitch;
                u.rate = rate; // å¥—ç”¨æ…¢é€Ÿ
                u.lang = 'zh-TW';
                window.speechSynthesis.speak(u);
            }
        }

        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            if (type === 'eat') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(300, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(600, audioCtx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.5, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                osc.start(); osc.stop(audioCtx.currentTime + 0.1);
            } else if (type === 'win') {
                playNote(523,0,0.2); playNote(659,0.2,0.2); playNote(784,0.4,0.4);
            }
        }

        function playNote(f, t, d) {
            const o = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            o.connect(g); g.connect(audioCtx.destination);
            o.frequency.value = f;
            g.gain.setValueAtTime(0.2, audioCtx.currentTime + t);
            g.gain.linearRampToValueAtTime(0, audioCtx.currentTime + t + d);
            o.start(audioCtx.currentTime + t); o.stop(audioCtx.currentTime + t + d);
        }

        // --- ä»‹é¢é‚è¼¯ ---
        const screens = { select: document.getElementById('selection-screen'), game: document.getElementById('game-screen'), draw: document.getElementById('drawing-screen') };
        
        function switchScreen(name) {
            Object.values(screens).forEach(s => s.classList.add('hidden'));
            screens[name].classList.remove('hidden');
        }

        function initMenu() {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            characters.forEach(char => {
                let card = document.createElement('div');
                card.className = 'char-card';
                card.innerHTML = `<span class="char-icon">${char.icon}</span><span class="char-name">${char.name}</span>`;
                // é»é¸æ™‚ï¼Œå…ˆå”¸å‡ºåå­—ï¼Œå†é–‹å§‹
                card.onclick = () => {
                    speak(char.name, 1, 0.8); // å”¸åå­—
                    setTimeout(() => startGame(char), 500); // å»¶é²ä¸€ä¸‹å†é€²éŠæˆ²
                };
                grid.appendChild(card);
            });
        }

        function startGame(char) {
            selectedChar = char;
            currentBites = totalBites;
            switchScreen('game');

            document.getElementById('char-display').innerText = char.icon;
            document.getElementById('message').innerText = char.msg;
            document.getElementById('count').innerText = currentBites;
            document.getElementById('progressBar').style.width = '100%';
            document.getElementById('progressBar').style.backgroundColor = '#66BB6A';
            
            const btn = document.getElementById('feedBtn');
            btn.disabled = false;
            btn.innerText = "é¤µä»–åƒ ğŸ¥„";
            btn.style.backgroundColor = '#FF6F00';

            // é€²å…¥ç•«é¢å¾Œï¼Œè‡ªå‹•å”¸å‡ºé–‹å ´ç™½
            setTimeout(() => {
                speak(`æˆ‘æ˜¯${char.name}ï¼Œ${char.msg}`, char.pitch, char.rate);
            }, 600);
        }

        function feedAction() {
            if (currentBites <= 0) return;
            currentBites--;
            document.getElementById('count').innerText = currentBites;
            
            let pct = (currentBites / totalBites) * 100;
            const pBar = document.getElementById('progressBar');
            pBar.style.width = pct + "%";
            if (pct < 30) pBar.style.backgroundColor = "#EF5350";

            const charDiv = document.getElementById('char-display');
            charDiv.classList.add('eating');
            playSound('eat');

            // éš¨æ©ŸèªéŸ³å›é¥‹
            const tastyWords = ["é˜¿å§†", "å¥½åƒ", "å†ä¾†", "çœŸæ£’"];
            const word = tastyWords[Math.floor(Math.random()*tastyWords.length)];
            // å”¸çŸ­èªï¼Œä¸æ‰“æ–·ç¯€å¥
            speak(word, selectedChar.pitch, 1.0); 

            setTimeout(() => {
                charDiv.classList.remove('eating');
                if (currentBites <= 0) finishGame();
            }, 300);
        }

        function finishGame() {
            const btn = document.getElementById('feedBtn');
            btn.innerText = "ä»»å‹™é”æˆ ğŸ‰";
            btn.disabled = true;
            btn.style.backgroundColor = "#66BB6A";
            document.getElementById('message').innerText = "åƒé£½äº†ï¼å¥å¥å¥½æ£’ï¼";
            document.body.style.backgroundColor = "#E8F5E9";

            playSound('win');
            // æ¸…æ¥šçš„çµæŸèªéŸ³
            speak(`åƒé£½äº†ï¼è¬è¬å¥å¥ï¼ä½ çœŸçš„å¥½æ£’å–”ï¼`, selectedChar.pitch, 0.8);

            let i = 0;
            let interval = setInterval(() => {
                if(i > 15) clearInterval(interval);
                createConfetti(); i++;
            }, 200);
        }

        function pokeCharacter() {
            const charDiv = document.getElementById('char-display');
            charDiv.classList.add('eating');
            setTimeout(()=>charDiv.classList.remove('eating'), 300);
            speak("æˆ‘è‚šå­å¥½é¤“å–”", selectedChar.pitch, selectedChar.rate);
        }

        function goHome() {
            switchScreen('select');
            document.body.style.backgroundColor = '#FFF8E1';
            speak("è¦é¸èª°å‘¢ï¼Ÿ", 1, 0.8);
        }
        
        // ç•«å¸ƒèˆ‡å½©å¸¶åŠŸèƒ½ (ç°¡åŒ–ä¿ç•™)
        function createConfetti() {
            const c = document.createElement('div');
            c.innerText = ['ğŸ‰','â­','ğŸˆ'][Math.floor(Math.random()*3)];
            c.style.position='absolute'; c.style.left=Math.random()*90+5+'vw'; c.style.top='-10vh';
            c.style.fontSize='2rem'; c.style.transition='top 2.5s ease-in';
            document.body.appendChild(c);
            setTimeout(()=>c.style.top='110vh',50); setTimeout(()=>c.remove(),2600);
        }
        
        let canvas, ctx, isDrawing=false;
        function goToDrawing() { switchScreen('draw'); initCanvas(); speak("ä¾†ç•«ç•«å§", 1, 0.8); }
        function initCanvas() {
            canvas=document.getElementById('drawCanvas'); ctx=canvas.getContext('2d');
            canvas.width=window.innerWidth; canvas.height=window.innerHeight;
            canvas.addEventListener('mousedown', sD); canvas.addEventListener('mousemove', d);
            canvas.addEventListener('mouseup', ()=>isDrawing=false);
            canvas.addEventListener('touchstart', (e)=>{e.preventDefault();const t=e.touches[0];sD({clientX:t.clientX,clientY:t.clientY})},{passive:false});
            canvas.addEventListener('touchmove', (e)=>{e.preventDefault();const t=e.touches[0];d({clientX:t.clientX,clientY:t.clientY})},{passive:false});
            canvas.addEventListener('touchend', ()=>isDrawing=false);
        }
        let brushColor='#4CAF50', brushSize=5;
        function sD(e){isDrawing=true; [lX,lY]=[e.clientX,e.clientY];}
        function d(e){if(!isDrawing)return; ctx.beginPath(); ctx.moveTo(lX,lY); ctx.lineTo(e.clientX,e.clientY); ctx.strokeStyle=brushColor; ctx.lineWidth=brushSize; ctx.lineCap='round'; ctx.stroke(); [lX,lY]=[e.clientX,e.clientY];}
        function setColor(c,b){brushColor=c; brushSize=5; document.querySelectorAll('.color-btn').forEach(x=>x.classList.remove('active')); b.classList.add('active'); speak("æ›é¡è‰²",1,0.8);}
        function setEraser(){brushColor='#FFF'; brushSize=30; speak("æ©¡çš®æ“¦",1,0.8);}
        function clearCanvas(){if(confirm('é‡ç•«?'))ctx.clearRect(0,0,canvas.width,canvas.height);}
        
        initMenu();
    </script>
</body>
</html>
